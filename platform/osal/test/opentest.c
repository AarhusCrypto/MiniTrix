#include <osal.h>
#include <testcase.h>

static int openip(OE oe) {
	
	byte buf[64] = { 0 };
	uint lbuf = sizeof(buf);
	uint fd = 0; 
	RC rc = RC_OK;
	oe->open("ip 87.104.238.146 80",&fd);
	if (!fd) {
		oe->p("Failed to connect to IP-address 87.104.238.146 on port 80.");
		return 0;
	} else {
	 
	  uint written = 19;
	  oe->write(fd, (byte*)"GET / HTTP/1.0\n\n\n", &written);
		if (written != 19) {
			oe->p("Failed to write 19 bytes to server at 87.104.238.146  port 80.");
			return 0;
		}
		rc =  oe->read(fd, buf, &lbuf);
		oe->close(fd);
		if (rc != RC_OK) {
			if (lbuf != sizeof(buf)) {
				oe->p("Read too few bytes.");
				return 0;
			}
		}

		return 1;
	}
}

static int test_listen(OE oe) {
  uint fd = 0;
  oe->open("listen 2020",&fd);
	if (!fd) {
		oe->p("Unable to listen on port 2020");
		return 0;
	}
	else {
		oe->p("Accepting connections on 2020");
		return 1;
	}
}

static int test_open_file(OE oe) {
  uint fd = 0;
  oe->open("file C:\\Users\\rwl\\test.txt",&fd);

	if (!fd) {
		oe->p("unable to open file test.txt");
		return 0;
	}
	else {
		oe->p("test.txt successfully opened");
		oe->close(fd);
		return 1;
	}
}

static int test_write(OE oe) {
	byte buf[] = { "Rasmus Zakarias" };
	uint lbuf = sizeof(buf);
	uint fd = 0;
	oe->open("file .\\test.txt",&fd);
	if (oe->write(fd, buf, &lbuf) == RC_OK && lbuf == sizeof(buf)) {
		oe->p("Successfully wrote test.txt");
		oe->close(fd);
		return 1;
	}	else{
		oe->p("Failed to write to test.txt");
		oe->close(fd);
		return 0;
	}
}

static int test_read(OE oe) {
	byte buf[10] = { 0 };
	uint lbuf = sizeof(buf);
	uint fd = 0;
	oe->open("file .\\test.txt",&fd);
	if (oe->read(fd, buf, &lbuf) == RC_OK && lbuf == sizeof(buf)) {
		oe->p("Successfully read 10 bytes");
		oe->close(fd);
		return 1;
	} else {
		oe->p("Failed to read 10 bytes from test.txt");
		oe->close(fd);
		return 0;
	}
}


static Test tests[] = { 
	{"Check that we can use open with ip and read from the result" , openip },
	{"Check that we can create a listning socket",test_listen},
	{"Check that we can open a file", test_open_file}, // 
	{ "Check that we can write a file", test_write },  // needs to go before the read test
	{"Check that we can read a file}", test_read },
	{ "Check that we can open a file and play with it", test_open_file } 
};


static TestSuit opensuit = {
	"The open test suit (read, write, listen too)",
	0,0,
	tests,
	sizeof(tests) / sizeof(Test)
};

TestSuit * open_test_suit(OE oe) {
	return &opensuit;
}
